# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ClaudeBar is a macOS menu bar application that monitors AI coding assistant usage quotas (Claude, Codex, Gemini, GitHub Copilot, Antigravity). It probes CLI tools to fetch quota information and displays it in a menu bar interface with system notifications for status changes.

## Build & Test Commands

### Using Swift Package Manager (CLI)

```bash
# Build the project
swift build

# Run all tests
swift test

# Run a specific test file
swift test --filter DomainTests

# Run a specific test
swift test --filter "QuotaMonitorTests/monitor fetches usage from a single provider"

# Run the app (requires macOS 15+)
swift run ClaudeBar
```

### Using Tuist (Xcode with SwiftUI Previews)

The project uses [Tuist](https://tuist.io) to generate Xcode projects with proper build settings for SwiftUI previews.

```bash
# Generate Xcode project (required before opening in Xcode)
tuist generate

# Open in Xcode (after generating)
open ClaudeBar.xcworkspace

# Regenerate after changing Project.swift
tuist generate
```

**Key files:**
- `Project.swift` - Tuist project definition (targets, dependencies, build settings)
- `Tuist.swift` - Tuist configuration
- `Package.swift` - Still used for SPM dependencies and CLI builds

**Note:** `*.xcodeproj` and `*.xcworkspace` are git-ignored since they're generated by Tuist.

## Architecture

The project follows a layered architecture with `QuotaMonitor` as the single source of truth:

```
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
│                                                                      │
│  QuotaMonitor (@Observable) - Single Source of Truth                │
│  ├── providers: AIProviders (private repository)                    │
│  ├── Delegation: allProviders, enabledProviders, provider(for:)     │
│  ├── Selection: selectedProviderId, selectedProvider                │
│  └── Operations: refreshAll(), addProvider(), removeProvider()      │
│                                                                      │
│  AIProviders (@Observable) - Repository                              │
│  ├── all: [AIProvider]                                              │
│  ├── enabled: [AIProvider] (filters by isEnabled)                   │
│  └── add(), remove(), provider(id:)                                 │
│                                                                      │
│  AIProvider (@Observable) - Rich Domain Model                        │
│  ├── isEnabled: Bool (persisted to UserDefaults)                    │
│  ├── snapshot: UsageSnapshot?                                       │
│  └── refresh() async                                                │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              │ Views consume directly (no AppState)
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           APP LAYER                                  │
│  ClaudeBarApp: @State var monitor: QuotaMonitor                     │
│  Views: MenuContentView(monitor), SettingsView(monitor)             │
└─────────────────────────────────────────────────────────────────────┘
```

### Layers

- **Domain** (`Sources/Domain/`): Pure business logic with no external dependencies
  - Provider (`Provider/`):
    - `AIProvider` protocol - rich domain model with `isEnabled` state
    - `AIProviders` - repository for provider collection management
    - `UsageProbe` protocol, rich models (`UsageQuota`, `UsageSnapshot`, `QuotaStatus`)
  - Monitor (`Monitor/`): `QuotaMonitor` @Observable class (single source of truth) and `QuotaStatusListener` protocol

- **Infrastructure** (`Sources/Infrastructure/`): Technical implementations
  - CLI (`CLI/`): Probes and protocols for CLI interaction
    - `ClaudeUsageProbe` - probes Claude CLI, uses `CLIExecutor` for testability
    - `CodexUsageProbe` - delegates to `CodexRPCClient` (single dependency)
    - `CodexRPCClient` protocol - "Is it available?" and "Get my stats"
    - `DefaultCodexRPCClient` - RPC via `RPCTransport`, falls back to TTY via `CLIExecutor`
    - `CLIExecutor` protocol - abstracts CLI interaction (locate binary, execute commands)
    - `RPCTransport` protocol - abstracts JSON-RPC communication
    - `GeminiUsageProbe` - coordinates `GeminiAPIProbe` with network client
    - `GeminiProjectRepository` - discovers Gemini projects for quota lookup
    - `CopilotUsageProbe` - probes GitHub Copilot usage via credentials and API
    - `AntigravityUsageProbe` - probes local Antigravity language server via process detection and local API
  - Adapters (`Adapters/`): Pure adapters for 3rd party interaction (excluded from coverage)
    - `PTYCommandRunner` - runs CLI commands with PTY for interactive prompts
    - `ProcessRPCTransport` - JSON-RPC over Process stdin/stdout pipes
    - `DefaultCLIExecutor` - real CLI execution using PTYCommandRunner
    - `InsecureLocalhostNetworkClient` - NetworkClient that accepts self-signed certs for localhost (used by Antigravity)
  - Network (`Network/`): `NetworkClient` protocol for HTTP abstraction
  - Notifications (`Notifications/`): `QuotaAlerter` - alerts users when quota degrades

- **App** (`Sources/App/`): SwiftUI menu bar application
  - Views directly consume `QuotaMonitor` (no ViewModel, no AppState layer)
  - `StatusBarIcon` - menu bar icon with status indicator

### Key Patterns

- **Protocol-Based DI**: Domain defines protocols (`UsageProbe`, `QuotaStatusListener`), infrastructure provides implementations
- **@Observable pattern**: `QuotaMonitor` and `AIProviders` use `@Observable` for SwiftUI reactivity
- **Mockable protocol mocks**: Uses `@Mockable` macro from Mockable package for test doubles
- **Swift Testing framework**: Tests use `@Test` and `@Suite` attributes, not XCTest
- **Adapters folder**: Pure 3rd-party wrappers excluded from code coverage

### Testability Design

The codebase separates testable logic from external system interaction:

- **Protocols with `@Mockable`**: `CLIExecutor`, `RPCTransport`, `CodexRPCClient`, `NetworkClient` - all mockable for unit tests
- **Adapters folder**: Pure adapters (`PTYCommandRunner`, `ProcessRPCTransport`) are excluded from code coverage since they only wrap system APIs
- **Parsing logic**: Kept as static/internal methods for direct testing without mocks

### Adding a New AI Provider

Use the **add-provider** skill to guide you through adding new AI providers following TDD patterns:

```
Tell Claude Code: "I want to add a new provider for [ProviderName]"
```

The skill will guide you through:

1. **Parsing Tests** → Create tests for API/CLI response parsing first
2. **Probe Behavior Tests** → Test detection and error handling with mocks
3. **Probe Implementation** → Implement `UsageProbe` in `Sources/Infrastructure/CLI/`
4. **Provider Class** → Create `AIProvider` in `Sources/Domain/Provider/`
5. **Registration** → Add to `ClaudeBarApp.init()` providers array

**Skill location:** `.claude/skills/add-provider/SKILL.md`

**Reference implementation:** See `AntigravityUsageProbe` for a complete example of:
- Local process detection via `ps` and `lsof`
- CSRF token extraction from process args
- Local API calls with self-signed cert handling
- Parsing JSON responses to `UsageSnapshot` with `UsageQuota` array

## Assets

The project uses a standard Xcode asset catalog for images:

```
Sources/App/Resources/
├── Assets.xcassets/           # Used at runtime
│   ├── AppIcon.appiconset/    # App icon (all sizes)
│   ├── AppLogo.imageset/      # App logo
│   ├── ClaudeIcon.imageset/   # Provider icons (PNG @1x, @2x, @3x)
│   ├── CodexIcon.imageset/
│   ├── CopilotIcon.imageset/
│   ├── GeminiIcon.imageset/
│   └── AntigravityIcon.imageset/
├── ClaudeIcon.svg             # Source SVG files (kept for reference)
├── CodexIcon.svg
├── CopilotIcon.png
├── GeminiIcon.svg
└── AntigravityIcon.svg
```

- **Runtime**: PNGs from `Assets.xcassets` loaded via `NSImage(named:)`
- **Source**: SVGs kept as original files for future regeneration

## Versioning & Release

### How Version Updates Work (with Tuist)

The release workflow updates version before Tuist generates the project:

```
1. GitHub Action triggered (tag v1.0.0 or manual input)
2. Update Info.plist ← PlistBuddy sets CFBundleShortVersionString
3. tuist generate   ← Reads updated Info.plist
4. xcodebuild       ← Builds app with correct version
5. Sparkle appcast  ← Generated with version for auto-updates
```

**Key files:**
- `Sources/App/Info.plist` - Source of truth for version (`CFBundleShortVersionString`, `CFBundleVersion`)
- `Project.swift` - References Info.plist: `infoPlist: .file(path: "Sources/App/Info.plist")`

### Manual Version Update (Local Development)

```bash
# Update version in Info.plist
/usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString 1.0.0" Sources/App/Info.plist
/usr/libexec/PlistBuddy -c "Set :CFBundleVersion 1" Sources/App/Info.plist

# Regenerate Xcode project
tuist generate
```

### Creating a Release

```bash
# Tag and push to trigger release workflow
git tag v1.0.0
git push origin v1.0.0
```

Or use the manual workflow dispatch in GitHub Actions with version input.

## Logging

The app uses a **dual-output logging system** via `AppLog` in `Sources/Infrastructure/Logging/`:

- **OSLog** (for developers): Full privacy controls, visible in Console.app
- **File** (for users): Persistent logs at `~/Library/Logs/ClaudeBar/ClaudeBar.log`

### AppLog Categories

```swift
AppLog.monitor        // QuotaMonitor operations
AppLog.providers      // AI provider lifecycle  
AppLog.probes         // CLI probe execution
AppLog.network        // HTTP requests/responses
AppLog.credentials    // Token management (redact sensitive data!)
AppLog.ui             // SwiftUI view lifecycle
AppLog.notifications  // System notifications
AppLog.updates        // Sparkle updates
```

### Log Levels and Output

| Level | Method | OSLog | File | Use Case |
|-------|--------|-------|------|----------|
| `debug` | `.debug()` | ✅ | ❌ | Development diagnostics (too verbose for file) |
| `info` | `.info()` | ✅ | ✅ | Informational events |
| `notice` | `.notice()` | ✅ | ✅ | Significant events |
| `warning` | `.warning()` | ✅ | ✅ | Potential issues |
| `error` | `.error()` | ✅ | ✅ | Recoverable errors |

### Privacy Rules

Since `AppLog` uses simple String parameters (not OSLog interpolation), you must manually redact sensitive data:

```swift
// ✅ Correct - redact sensitive data
AppLog.credentials.info("Token refreshed for provider")
AppLog.probes.error("Probe failed: \(error.localizedDescription)")

// ❌ Wrong - exposes secrets in file log
AppLog.credentials.info("Token: \(accessToken)")
```

For sensitive debugging that needs OSLog privacy controls, use OSLog directly.

### File Logging Details

- **Location**: `~/Library/Logs/ClaudeBar/ClaudeBar.log`
- **Rotation**: Rotates to `ClaudeBar.old.log` at 5MB
- **Format**: `[YYYY-MM-DD HH:MM:SS] [LEVEL] [category] message`
- **Access**: Settings → "Open Logs Folder" button

### Viewing Logs

**File logs (for users):**
```bash
# Open in Finder (or use Settings → Open Logs Folder)
open ~/Library/Logs/ClaudeBar/

# Tail the log
tail -f ~/Library/Logs/ClaudeBar/ClaudeBar.log
```

**OSLog (for developers):**
```bash
# Console.app filter
subsystem:com.tddworks.ClaudeBar

# Terminal - show all levels (including debug)
log show --predicate 'subsystem == "com.tddworks.ClaudeBar"' --info --debug --last 1h

# Terminal - errors only
log show --predicate 'subsystem == "com.tddworks.ClaudeBar" AND messageType == error' --last 1h

# Live stream (for debugging)
log stream --predicate 'subsystem == "com.tddworks.ClaudeBar"' --info --debug
```

### Debugging Probe Issues

When a probe fails (e.g., `claude /usage`), all errors are logged with context:

```bash
# File log - grep for probe issues
grep -i "probe" ~/Library/Logs/ClaudeBar/ClaudeBar.log

# OSLog - probe-specific logs
log show --predicate 'subsystem == "com.tddworks.ClaudeBar" AND category == "probes"' --info --debug --last 1h
```

Common error patterns logged:
- `"Claude probe failed: token has expired"` → Re-login required
- `"Claude probe blocked: folder trust required"` → Trust the folder in Claude CLI
- `"Codex probe failed: data not available yet"` → Wait for Codex to sync
- `"Gemini probe failed: no access token"` → Re-authenticate with Gemini CLI
- `"Antigravity probe failed: server not found"` → Ensure Antigravity app is running locally

## Dependencies

- **Sparkle**: Auto-update framework for macOS
- **Mockable**: Protocol mocking for tests via Swift macros
- **Tuist**: Xcode project generation for SwiftUI previews (`ENABLE_DEBUG_DYLIB`)
